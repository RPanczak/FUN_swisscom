---
title: "Analyses of swisscom data"
subtitle: "API data"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, magrittr, scales,  
       lubridate, 
       sf, tmap)

tmap_mode("view")

# import::from("sjmisc", "frq")
```

```{r conflicts, include = FALSE}
tidyverse::tidyverse_conflicts()

conflicted::conflict_scout()
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Data 

## Grid 

Testing on 3011 ftm.  

```{r}
bern_plz <- read_rds("data/grid/bern_plz.Rds") %>% 
  select(-area, -GMDNR, -GMDNAME, -KTNR, -GEM_TEIL) %>% 
  rename(tile_id = tileId)

bern_plz_ct <- st_centroid(bern_plz)
```

```{r eval=FALSE, include=FALSE}
View(st_drop_geometry(bern_plz))
```

```{r echo=FALSE}
# tm_shape(bern_plz) + 
#   tm_borders(col = "darkorchid") +
#   tm_shape(bern_plz_ct) + 
#   tm_dots(col = "grey50")

tm_shape(bern_plz) + 
  tm_borders(col = "darkorchid")
```

# Dwell density 

Data is from http://mip.swisscom.ch which swisscom describes as: 

> Our new API platform offering 3 endpoints focusing on *density*, *dwell times* and *origin destination*  

Important note: free data is limited to **2020-01-27** only!  

We are using [Heatmaps API](https://digital.swisscom.com/products/heatmaps/info) to retrieve daily and hourly dwell times for one postcode. Code to retrieve data, kindly provided by Yann Steimer from swisscom, is in `example_notebook_SC_heatmaps_API_UNIBE.ipynb`.   

## Daily dwell density

```{r}
data_day <- read_delim("data/swisscom/3011_day.csv", 
                       delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  select(tile_id, time, score)
```

## Hourly dwell density

```{r}
data_hour <- read_delim("data/swisscom/3011_hour.csv", 
                        delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  select(tile_id, time, score)
```

```{r eval=FALSE, include=FALSE}
View(data_day)
View(data_hour)
```

<!-- ----------------------------------------------------- -->

# EDA

## Daily 

```{r}
bern_plz_day <- bern_plz %>% 
  left_join(data_day %>% select(-time))
```

```{r echo=FALSE}
bern_plz_day %>% 
  tm_shape() + 
  tm_polygons(col = "score", alpha = 0.5, palette = "-plasma",
              n = 7, style = "jenks",
              border.col = "white", border.alpha = 0.5)
```

## Hourly 

```{r}
bern_plz_hour <- bern_plz %>% 
  left_join(data_hour)
```

```{r echo=FALSE}
bern_plz_hour %>% 
  st_drop_geometry() %>% 
  ggplot(aes(x = time, y = score, group = tile_id, colour = tile_id)) +
  geom_line(alpha = 0.5) + 
  theme_light()
```

```{r echo=FALSE}
bern_plz_hour %>% 
  filter(hour(time) %in% c(0, 12)) %>% 
  mutate(daytime = ifelse(hour(time) == 0, "Midnight", "Noon")) %>% 
  tm_shape() + 
  tm_polygons(col = "score", alpha = 0.5, palette = "-plasma",
              n = 7, style = "jenks",
              border.col = "white", border.alpha = 0.5) +
  tm_facets(by = "daytime")
```

