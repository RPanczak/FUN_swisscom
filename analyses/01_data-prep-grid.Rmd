---
title: "Analyses of swisscom data"
subtitle: "Grid preparation"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, magrittr, scales,  
       # DT, 
       sf, tmap)

tmap_mode("view")

# import::from("sjmisc", "frq")
```

```{r conflicts, include = FALSE}
tidyverse::tidyverse_conflicts()

conflicted::conflict_scout()
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Ancillary data

## Municipality boundaries 

```{r}
st_gg21 <- st_read("data-raw/swisstopo/swissboundaries3d_2021-07_2056_5728/SHAPEFILE_LV95_LN02/swissBOUNDARIES3D_1_3_TLM_HOHEITSGEBIET.shp",
                   as_tibble = TRUE) %>% 
  st_zm(drop = TRUE, what = "ZM") %>% 
  # filter(! BFS_NUMMER %in% c(2391, 5391, 5394)) %>% 
  # exclude lakes
  # filter(OBJEKTART != "Kantonsgebiet") %>% 
  # exclude FL & enclaves
  filter(ICC == "CH") %>% 
  select(BFS_NUMMER, NAME, KANTONSNUM, GEM_TEIL) %>% 
  rename(GMDNR = BFS_NUMMER,
         GMDNAME = NAME,
         KTNR = KANTONSNUM) %>% 
  arrange(GMDNR)
```

```{r eval=FALSE, include=FALSE}
st_cities_1 <- st_gg21 %>% 
  filter(GMDNR %in% c(261, 6621, 2701, 5586, 351))

st_cities_2 <- st_gg21 %>% 
  filter(GMDNR %in% c(230, 1061, 3203, 5192, 371))

# st_cities %>% 
#   st_geometry() %>% 
#   plot()
```

## STATPOP

Could be used to define `offset` for `st_make_grid`

```{r}
statpop_20 <- read_delim("data-raw/BfS/ag-b-00.03-vz2020statpop/STATPOP2020.zip", 
                         delim = ";", escape_double = FALSE, trim_ws = TRUE)[] %>% 
  mutate_all(as.integer)

offset <- statpop_20 %>% 
  summarise(minX = min(E_KOORD),
            minY = min(N_KOORD))

# statpop_20 %>% slice(1:10) %>% View()
rm(statpop_20); gc()
```

<!-- ----------------------------------------------------- -->

# Grid

## Generate whole country

100 m grid, with lower left corner defined using `STATPOP` cells and clipped using swisstopo municipality data.  

Also, adding ID for each cell (based on row number) and area. 

FIXME: crashing R and unable to complete

```{r eval=FALSE, include=FALSE}
country <- st_gg21 %>% 
  st_make_grid(cellsize = 100, 
               offset = c(offset$minX, offset$minY),
               square = TRUE) %>% 
  st_sf() %>%
  st_cast("POLYGON") %>% 
  mutate(ID1 = row_number()) %>% 
  relocate(ID1)

bern <- country %>% 
  st_intersection(st_gg21 %>% filter(GMDNR == 351))  %>%
  mutate(ID2 = row_number(),
         area = st_area(.)) %>% 
  relocate(ID1, ID2, area)
```

## Generate cities

### Zuirich

```{r}
area_filter <- st_gg21 %>% 
  filter(GMDNR == 261)

zurich <- area_filter %>% 
  st_make_grid(cellsize = 100, 
               # offset = c(offset$minX, offset$minY), 
               square = TRUE) %>% 
  st_sf() %>% 
  st_cast("POLYGON") %>% 
  st_intersection(area_filter)  %>%
  mutate(ID = row_number(),
         area = st_area(.)) %>% 
  relocate(ID, area)

rm(area_filter); gc()
```

### Geneva

```{r}
area_filter <- st_gg21 %>% 
  filter(GMDNR == 6621)

geneva <- area_filter %>% 
  st_make_grid(cellsize = 100, 
               # offset = c(offset$minX, offset$minY), 
               square = TRUE) %>% 
  st_sf() %>% 
  st_cast("POLYGON") %>% 
  st_intersection(area_filter)  %>%
  mutate(ID = row_number(),
         area = st_area(.)) %>% 
  relocate(ID, area)

rm(area_filter); gc()
```

### Basel

```{r}
area_filter <- st_gg21 %>% 
  filter(GMDNR == 2701)

basel <- area_filter %>% 
  st_make_grid(cellsize = 100, 
               # offset = c(offset$minX, offset$minY), 
               square = TRUE) %>% 
  st_sf() %>% 
  st_cast("POLYGON") %>% 
  st_intersection(area_filter)  %>%
  mutate(ID = row_number(),
         area = st_area(.)) %>% 
  relocate(ID, area)

rm(area_filter); gc()
```

### Lausanne

```{r}
area_filter <- st_gg21 %>% 
  filter(GMDNR == 5586)

lausanne <- area_filter %>% 
  st_make_grid(cellsize = 100, 
               # offset = c(offset$minX, offset$minY), 
               square = TRUE) %>% 
  st_sf() %>% 
  st_cast("POLYGON") %>% 
  st_intersection(area_filter)  %>%
  mutate(ID = row_number(),
         area = st_area(.)) %>% 
  relocate(ID, area)

rm(area_filter); gc()
```

### Bern 

```{r}
area_filter <- st_gg21 %>% 
  filter(GMDNR == 351)

bern <- area_filter %>% 
  st_make_grid(cellsize = 100, 
               # offset = c(offset$minX, offset$minY), 
               square = TRUE) %>% 
  st_sf() %>% 
  st_cast("POLYGON") %>% 
  st_intersection(area_filter)  %>%
  mutate(ID = row_number(),
         area = st_area(.)) %>% 
  relocate(ID, area)

rm(area_filter); gc()
```

```{r eval=FALSE}
st_write(bern, "data/grid/bern.gpkg")
write_rds(bern, "data/grid/bern.Rds")
```

## Example 

Municipality Bern coverage:  

```{r}
bern %>% 
  st_geometry() %>% 
  plot()
```

```{r}
bern %>% 
  st_geometry() %>% 
  qtm(borders = "red", fill = NULL)
```

There are few examples of grid cells with very small area.  
These could be excluded if no population was found there?

```{r}
bern %>% 
  st_drop_geometry() %>% 
  arrange(area) %>% 
  slice(1:10)
```

<!-- ----------------------------------------------------- -->

# Area estimates

```{r}
nrow(bern)


nrow(zurich) +
  nrow(geneva) +
  nrow(basel) +
  nrow(lausanne) +
  nrow(bern)
```

